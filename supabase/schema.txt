
-- THE COZY NOOK - PRODUCTION DATABASE SCHEMA (v3.5)
-- This script initializes the tables, security policies, and storage buckets required for the app.

-- 1. EXTENSIONS
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 2. PROFILES TABLE
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY,
  full_name TEXT,
  email TEXT,
  role TEXT DEFAULT 'guest' CHECK (role IN ('admin', 'guest', 'delegate')),
  has_logged_in_before BOOLEAN DEFAULT FALSE,
  is_suspended BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. LISTINGS TABLE (The core inventory)
CREATE TABLE IF NOT EXISTS public.listings (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  type TEXT NOT NULL,
  price NUMERIC NOT NULL,
  description TEXT,
  short_summary TEXT,
  amenities JSONB DEFAULT '[]'::jsonb,
  images JSONB DEFAULT '[]'::jsonb, -- Array of {url, caption}
  max_guests INTEGER DEFAULT 2,
  bedrooms INTEGER DEFAULT 1,
  bathrooms INTEGER DEFAULT 1,
  address TEXT,
  check_in_method TEXT,
  check_in_time TEXT,
  check_out_time TEXT,
  cleaning_fee NUMERIC DEFAULT 0,
  security_deposit NUMERIC DEFAULT 0,
  min_stay INTEGER DEFAULT 1,
  max_stay INTEGER DEFAULT 30,
  house_rules JSONB DEFAULT '{}'::jsonb,
  host_info JSONB DEFAULT '{}'::jsonb,
  guest_experience JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4. BOOKINGS TABLE
CREATE TABLE IF NOT EXISTS public.bookings (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
  listing_id TEXT REFERENCES public.listings(id) ON DELETE CASCADE,
  check_in DATE NOT NULL,
  check_out DATE NOT NULL,
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'cancelled')),
  total_amount NUMERIC NOT NULL,
  guest_count INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 5. SITE CONFIGURATION (Hero images, system flags)
CREATE TABLE IF NOT EXISTS public.site_config (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 6. SECURITY (RLS)
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.listings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.bookings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.site_config ENABLE ROW LEVEL SECURITY;

-- 7. GLOBAL POLICIES (Idempotent)
DO $$ 
BEGIN
    -- Listings: Everyone can view, only Admins can manage
    DROP POLICY IF EXISTS "Public: View Listings" ON public.listings;
    CREATE POLICY "Public: View Listings" ON public.listings FOR SELECT USING (true);
    
    DROP POLICY IF EXISTS "Admin: All Listings" ON public.listings;
    CREATE POLICY "Admin: All Listings" ON public.listings FOR ALL TO authenticated 
    USING ((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'admin');

    -- Bookings: Admins see all, Guests see their own
    DROP POLICY IF EXISTS "Bookings: Admin Access" ON public.bookings;
    CREATE POLICY "Bookings: Admin Access" ON public.bookings FOR ALL TO authenticated 
    USING ((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'admin');

    DROP POLICY IF EXISTS "Bookings: Guest Self-Access" ON public.bookings;
    CREATE POLICY "Bookings: Guest Self-Access" ON public.bookings FOR SELECT TO authenticated 
    USING (auth.uid() = user_id);

    -- Profiles: Public can read basic info, Admins manage all, Users update self
    DROP POLICY IF EXISTS "Profiles: Public View" ON public.profiles;
    CREATE POLICY "Profiles: Public View" ON public.profiles FOR SELECT USING (true);
    
    DROP POLICY IF EXISTS "Profiles: User Update Self" ON public.profiles;
    CREATE POLICY "Profiles: User Update Self" ON public.profiles FOR UPDATE USING (auth.uid() = id);

    -- Site Config: Public read, Admin write
    DROP POLICY IF EXISTS "Config: Public Read" ON public.site_config;
    CREATE POLICY "Config: Public Read" ON public.site_config FOR SELECT USING (true);

    DROP POLICY IF EXISTS "Config: Admin Manage" ON public.site_config;
    CREATE POLICY "Config: Admin Manage" ON public.site_config FOR ALL TO authenticated 
    USING ((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'admin');
END $$;

-- 8. STORAGE SETUP (Crucial for Admin Image Uploads)
INSERT INTO storage.buckets (id, name, public) 
VALUES ('listing-images', 'listing-images', true)
ON CONFLICT (id) DO NOTHING;

DO $$
BEGIN
    -- Allow everyone to view images
    DROP POLICY IF EXISTS "Public Access" ON storage.objects;
    CREATE POLICY "Public Access" ON storage.objects FOR SELECT USING ( bucket_id = 'listing-images' );

    -- Only Admins can upload to the listing-images bucket
    DROP POLICY IF EXISTS "Admin Upload" ON storage.objects;
    CREATE POLICY "Admin Upload" ON storage.objects FOR INSERT TO authenticated 
    WITH CHECK (
      bucket_id = 'listing-images' AND 
      (SELECT role FROM public.profiles WHERE id = auth.uid()) = 'admin'
    );

    -- Only Admins can update or delete objects
    DROP POLICY IF EXISTS "Admin Update/Delete" ON storage.objects;
    CREATE POLICY "Admin Update/Delete" ON storage.objects FOR ALL TO authenticated 
    USING (
      bucket_id = 'listing-images' AND 
      (SELECT role FROM public.profiles WHERE id = auth.uid()) = 'admin'
    );
END $$;
